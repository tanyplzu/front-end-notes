---
sidebarDepth: 0
---

# 前端监控体系

[[toc]]

## 数据埋点与收集

- 系统的生命周期数据，可用于观察页面性能情况、整体访问情况等。
- HTTP 测速数据，可用于观察外部服务调用情况 、页面性能优化等。
- 系统异常数据，可用于观察系统稳定性、系统异常问题。
- 用户行为数据，可用于观察页面稳定性、整体访问情况等。
- 用户日志，用于进行用户反馈的问题排查。

### 生命周期数据

通过 `PerformanceTiming` 属性中获取到一些生命周期相关的数据：

- 用于页面跳转：navigationStart、unloadEventStart/unloadEventEnd 等。
- 用于页面加载：domLoading、domInteractive、domContentLoadedEventStart/domContentLoadedEventEnd、loadEventStart/loadEventEnd 等。

随着前端框架的使用，页面的渲染过程、页面间的切换等逻辑都交给了框架进行控制，因此像 DOMContentLoaded、readystatechange 这些事件已经失去了原本的作用。很多时候我们会在框架本身提供的生命周期函数中进行数据的收集，比如在 Vue 中就有 beforeCreate/created、beforeMount/mounted、beforeUpdate/updated、beforeDestroy/destroyed 这些生命周期的钩子。

除了框架本身提供的生命周期以外，我们还可以使用 `MutationObserver` 接口，该接口提供了监听页面 DOM 树变化的能力，结合 `performance` 获取到具体的时间。

```js
// 注册监听函数
const observer = new MutationObserver((mutations) => {
  console.log(`时间：${performance.now()}，DOM树发生了变化！有以下变化类型:`);
  for (let i = 0; i < mutations.length; i++) {
    console.log(mutations[0].type);
  }
});
// 开始监听 document 的节点变化
observer.observe(document, {
  childList: true,
  subtree: true,
});
```

### HTTP 测速数据

HTTP 请求相关的数据，同样可以通过 PerformanceTiming 属性获取，包括 HTTP 跳转开始/结束、域名查询开始/结束等各种时间戳。

### 系统异常数据

常见的前端异常包括：

- 逻辑错误，可理解为开发实现功能的时候，逻辑梳理不符合预期；
- 代码健壮性，可理解为代码边界情况考虑不周，异常逻辑执行出错；
- 网络错误，可理解为用户网络情况异常、后台服务异常等错误；
- 系统错误，可理解为代码运行环境兼容性问题导致出错；
- 页面内容异常，可理解为缺少内容、绑定事件异常、样式异常等。

对于 1-4 的异常情况，可以使用`window.onerror`、`document.addEventlistener(error)`、`XMLHttpRequest status`等方法来进行拦截，同时可获取错误相关的信息和数据。比如，通过监听 `window.onerror` 事件，我们可以获取项目中的错误和分析堆栈，将错误信息自动上报到后台服务中。

对于第 5 项的页面内容异常，大多数情况并不会影响系统中大多数功能的运行，同时也缺少可直观观察的数据信息。因此一般情况下，可以通过回归测试、UI 界面测试等方式在上线前进行避免。

### 用户行为数据

除了常见的前端页面加载、请求耗时数据，我们还可以关注用户的一些行为数据，包括页面浏览量或点击量、用户在每一个页面的停留时间、用户通过什么入口来访问该页面、用户在页面中的一些操作行为。用户行为数据可以结合 DOM 元素的事件监听、页面的加载情况等方式来获取。

### 用户日志

可以通过添加装饰器、对类方法进行劫持等方式来进行日志的自动打印

## 数据埋点与收集

数据埋点在业界中已经是比较成熟的解决方案，其中前端常见的埋点方案有三种：代码埋点、可视化埋点、无痕埋点。

## 资料来源

王贝珊（被删）[19 | 如何搭建前端监控体系为业务排忧解难？](https://kaiwu.lagou.com/course/courseInfo.htm?courseId=822#/detail/pc?id=7215)
