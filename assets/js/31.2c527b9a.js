(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{288:function(t,a,s){t.exports=s.p+"assets/img/timestamp-diagram.cff7c850.svg"},339:function(t,a,s){t.exports=s.p+"assets/img/navigation-timing.a9f7be2c.png"},481:function(t,a,s){"use strict";s.r(a);var n=s(6),e=Object(n.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"前端性能监控"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前端性能监控"}},[t._v("#")]),t._v(" 前端性能监控")]),t._v(" "),a("p"),a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#数据埋点与收集"}},[t._v("数据埋点与收集")]),a("ul",[a("li",[a("a",{attrs:{href:"#生命周期数据"}},[t._v("生命周期数据")])]),a("li",[a("a",{attrs:{href:"#确定统计起始点"}},[t._v("确定统计起始点")])]),a("li",[a("a",{attrs:{href:"#首字节"}},[t._v("首字节")])]),a("li",[a("a",{attrs:{href:"#白屏时间"}},[t._v("白屏时间")])]),a("li",[a("a",{attrs:{href:"#首屏时间"}},[t._v("首屏时间")])]),a("li",[a("a",{attrs:{href:"#指标采集"}},[t._v("指标采集")])]),a("li",[a("a",{attrs:{href:"#spa-页面采集"}},[t._v("SPA 页面采集")])]),a("li",[a("a",{attrs:{href:"#mutationobserver"}},[t._v("MutationObserver")])]),a("li",[a("a",{attrs:{href:"#http-测速数据"}},[t._v("HTTP 测速数据")])]),a("li",[a("a",{attrs:{href:"#系统异常数据"}},[t._v("系统异常数据")])]),a("li",[a("a",{attrs:{href:"#用户行为数据"}},[t._v("用户行为数据")])]),a("li",[a("a",{attrs:{href:"#用户日志"}},[t._v("用户日志")])])])]),a("li",[a("a",{attrs:{href:"#参考资料"}},[t._v("参考资料")])])])]),a("p"),t._v(" "),a("h2",{attrs:{id:"数据埋点与收集"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据埋点与收集"}},[t._v("#")]),t._v(" 数据埋点与收集")]),t._v(" "),a("ul",[a("li",[t._v("系统的生命周期数据，可用于观察页面性能情况、整体访问情况等。")]),t._v(" "),a("li",[t._v("HTTP 测速数据，可用于观察外部服务调用情况 、页面性能优化等。")]),t._v(" "),a("li",[t._v("系统异常数据，可用于观察系统稳定性、系统异常问题。")]),t._v(" "),a("li",[t._v("用户行为数据，可用于观察页面稳定性、整体访问情况等。")]),t._v(" "),a("li",[t._v("用户日志，用于进行用户反馈的问题排查。")])]),t._v(" "),a("h3",{attrs:{id:"生命周期数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#生命周期数据"}},[t._v("#")]),t._v(" 生命周期数据")]),t._v(" "),a("p",[t._v("Level 1 的规范:")]),t._v(" "),a("p",[a("img",{attrs:{src:s(339),alt:"W3C Navigation Timing Level 1(w3.org)"}})]),t._v(" "),a("p",[t._v("2012 年底进入候选建议阶段，至今仍在日常使用中；但是在 W3C 的议程上，它已经功成身退，让位给了精度更高，功能更强大，层次更分明的 Level 2。Level 2 如下图：")]),t._v(" "),a("p",[a("img",{attrs:{src:s(288),alt:"W3C Navigation Timing Level 2(w3.org)"}})]),t._v(" "),a("p",[t._v("通过 "),a("code",[t._v("PerformanceTiming")]),t._v(" 属性中获取到一些生命周期相关的数据：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 获取 performance 数据")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" performance "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// memory 是非标准属性，只在 Chrome 有")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("memory")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 多少内存")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("usedJSHeapSize")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16100000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// JS 对象（包括V8引擎内部对象）占用的内存，一定小于 totalJSHeapSize")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("totalJSHeapSize")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("35100000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 可使用的内存")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("jsHeapSizeLimit")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("793000000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 内存大小限制")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("navigation")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("redirectCount")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果有重定向的话，页面通过几次重定向跳转而来")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 0   即 TYPE_NAVIGATENEXT 正常进入的页面（非刷新、非重定向等）")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1   即 TYPE_RELOAD       通过 window.location.reload() 刷新的页面")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2   即 TYPE_BACK_FORWARD 通过浏览器的前进后退按钮进入的页面（历史记录）")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 255 即 TYPE_UNDEFINED    非以上方式进入的页面")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("timing")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 上图中的字段")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"确定统计起始点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#确定统计起始点"}},[t._v("#")]),t._v(" 确定统计起始点")]),t._v(" "),a("p",[t._v("页面性能统计的起始点时间，应该是用户输入网址回车后开始等待的时间。一个是通过 navigationStart 获取，相当于在 URL 输入栏回车或者页面按 F5 刷新的时间点；另外一个是通过 fetchStart，相当于浏览器准备好使用 HTTP 请求获取文档的时间。")]),t._v(" "),a("p",[t._v("从开发者实际分析使用的场景，浏览器重定向、卸载页面的耗时对页面加载分析并无太大作用；"),a("strong",[t._v("通常建议使用 fetchStart 作为统计起始点")]),t._v("。")]),t._v(" "),a("h3",{attrs:{id:"首字节"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#首字节"}},[t._v("#")]),t._v(" 首字节")]),t._v(" "),a("p",[t._v("主文档返回第一个字节的时间，是页面加载性能比较重要的指标。对用户来说一般无感知，对于开发者来说，则代表访问网络后端的整体响应耗时。")]),t._v(" "),a("h3",{attrs:{id:"白屏时间"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#白屏时间"}},[t._v("#")]),t._v(" 白屏时间")]),t._v(" "),a("p",[t._v("用户看到页面展示出现一个元素的时间。很多人认为白屏时间是页面返回的首字节时间，但这样其实并不精确，因为头部资源还没加载完毕，页面也是白屏。")]),t._v(" "),a("p",[t._v("相对来说具备「白屏时间」统计意义的指标，可以取 "),a("code",[t._v("domLoading")]),t._v(" - "),a("code",[t._v("fetchStart")]),t._v("，此时页面开始解析 DOM 树，页面渲染的第一个元素也会很快出现。")]),t._v(" "),a("p",[t._v("从 W3C Navigation Timing Level 2 的方案设计，可以直接采用 "),a("code",[t._v("domInteractive")]),t._v(" - "),a("code",[t._v("fetchStart")]),t._v("，此时页面资源加载完成，即将进入渲染环节。")]),t._v(" "),a("h3",{attrs:{id:"首屏时间"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#首屏时间"}},[t._v("#")]),t._v(" 首屏时间")]),t._v(" "),a("p",[t._v("首屏时间是指页面第一屏所有资源完整展示的时间。这是一个对用户来说非常直接的体验指标，但是对于前端却是一个非常难以统计衡量的指标。")]),t._v(" "),a("p",[t._v("具备一定意义上的指标可以使用，"),a("code",[t._v("domContentLoadedEventEnd")]),t._v(" - "),a("code",[t._v("fetchStart")]),t._v("，甚至使用 "),a("code",[t._v("loadEventStart")]),t._v(" - "),a("code",[t._v("fetchStart")]),t._v(" ，此时页面 DOM 树已经解析完成并且显示内容。")]),t._v(" "),a("h3",{attrs:{id:"指标采集"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#指标采集"}},[t._v("#")]),t._v(" 指标采集")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" times "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" t "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("performance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("timing"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 优先使用 navigation v2  https://www.w3.org/TR/navigation-timing-2/")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" win"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("PerformanceNavigationTiming "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'function'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" nt2Timing "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" performance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getEntriesByType")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'navigation'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nt2Timing"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      t "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" nt2Timing"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//重定向时间")]),t._v("\ntimes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("redirectTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("redirectEnd "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("redirectStart"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//dns查询耗时")]),t._v("\ntimes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dnsTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("domainLookupEnd "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("domainLookupStart"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//TTFB 读取页面第一个字节的时间")]),t._v("\ntimes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ttfbTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("responseStart "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("navigationStart"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//DNS 缓存时间")]),t._v("\ntimes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("appcacheTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("domainLookupStart "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("fetchStart"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//卸载页面的时间")]),t._v("\ntimes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("unloadTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("unloadEventEnd "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("unloadEventStart"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//tcp连接耗时")]),t._v("\ntimes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tcpTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("connectEnd "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("connectStart"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//request请求耗时")]),t._v("\ntimes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("reqTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("responseEnd "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("responseStart"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//解析dom树耗时")]),t._v("\ntimes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("analysisTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("domComplete "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("domInteractive"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//白屏时间")]),t._v("\ntimes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("blankTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("domInteractive "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("domLoading"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("fetchStart"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//domReadyTime")]),t._v("\ntimes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("domReadyTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("domContentLoadedEventEnd "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("fetchStart"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"spa-页面采集"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#spa-页面采集"}},[t._v("#")]),t._v(" SPA 页面采集")]),t._v(" "),a("p",[t._v("Navigation Timing API 可以监控大部分前端页面的性能。但随着 SPA 模式的盛行，类似 vue，reactjs 等框架的普及，页面内容渲染的时机被改变了，W3C 标准无法完全满足原来的监控意义。像 "),a("code",[t._v("DOMContentLoaded")]),t._v("、"),a("code",[t._v("readystatechange")]),t._v(" 这些事件已经失去了原本的作用。")]),t._v(" "),a("p",[t._v("很多时候我们会在框架本身提供的生命周期函数中进行数据的收集，比如在 Vue 中就有 "),a("code",[t._v("beforeCreate/created")]),t._v("、"),a("code",[t._v("beforeMount/mounted")]),t._v("、"),a("code",[t._v("beforeUpdate/updated")]),t._v("、"),a("code",[t._v("beforeDestroy/destroyed")]),t._v(" 这些生命周期的钩子。")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("注意点")]),t._v(" "),a("p",[t._v("通过 window.performance.timing 所获的的页面渲染所相关的数据，在 SPA 应用中改变了 url 但不刷新页面的情况下是不会更新的。因此仅仅通过该 api 是无法获得每一个子路由所对应的页面渲染的时间。如果需要上报切换路由情况下每一个子页面重新 render 的时间，需要自定义上报。")])]),t._v(" "),a("h3",{attrs:{id:"mutationobserver"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mutationobserver"}},[t._v("#")]),t._v(" MutationObserver")]),t._v(" "),a("p",[t._v("除了框架本身提供的生命周期以外，我们还可以使用 "),a("code",[t._v("MutationObserver")]),t._v(" 接口，该接口提供了监听页面 DOM 树变化的能力，结合 "),a("code",[t._v("performance")]),t._v(" 获取到具体的时间。")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 注册监听函数")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" observer "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MutationObserver")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("mutations")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("时间：")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("performance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("，DOM树发生了变化！有以下变化类型:")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" mutations"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mutations"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 开始监听 document 的节点变化")]),t._v("\nobserver"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("observe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("childList")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("subtree")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"http-测速数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#http-测速数据"}},[t._v("#")]),t._v(" HTTP 测速数据")]),t._v(" "),a("p",[t._v("HTTP 请求相关的数据，同样可以通过 PerformanceTiming 属性获取，包括 HTTP 跳转开始/结束、域名查询开始/结束等各种时间戳。")]),t._v(" "),a("h3",{attrs:{id:"系统异常数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#系统异常数据"}},[t._v("#")]),t._v(" 系统异常数据")]),t._v(" "),a("p",[t._v("常见的前端异常包括：")]),t._v(" "),a("ul",[a("li",[t._v("逻辑错误，可理解为开发实现功能的时候，逻辑梳理不符合预期；")]),t._v(" "),a("li",[t._v("代码健壮性，可理解为代码边界情况考虑不周，异常逻辑执行出错；")]),t._v(" "),a("li",[t._v("网络错误，可理解为用户网络情况异常、后台服务异常等错误；")]),t._v(" "),a("li",[t._v("系统错误，可理解为代码运行环境兼容性问题导致出错；")]),t._v(" "),a("li",[t._v("页面内容异常，可理解为缺少内容、绑定事件异常、样式异常等。")])]),t._v(" "),a("p",[t._v("对于 1-4 的异常情况，可以使用"),a("code",[t._v("window.onerror")]),t._v("、"),a("code",[t._v("document.addEventlistener(error)")]),t._v("、"),a("code",[t._v("XMLHttpRequest status")]),t._v("等方法来进行拦截，同时可获取错误相关的信息和数据。比如，通过监听 "),a("code",[t._v("window.onerror")]),t._v(" 事件，我们可以获取项目中的错误和分析堆栈，将错误信息自动上报到后台服务中。")]),t._v(" "),a("p",[t._v("对于第 5 项的页面内容异常，大多数情况并不会影响系统中大多数功能的运行，同时也缺少可直观观察的数据信息。因此一般情况下，可以通过回归测试、UI 界面测试等方式在上线前进行避免。")]),t._v(" "),a("h3",{attrs:{id:"用户行为数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#用户行为数据"}},[t._v("#")]),t._v(" 用户行为数据")]),t._v(" "),a("p",[t._v("除了常见的前端页面加载、请求耗时数据，我们还可以关注用户的一些行为数据，包括页面浏览量或点击量、用户在每一个页面的停留时间、用户通过什么入口来访问该页面、用户在页面中的一些操作行为。用户行为数据可以结合 DOM 元素的事件监听、页面的加载情况等方式来获取。")]),t._v(" "),a("h3",{attrs:{id:"用户日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#用户日志"}},[t._v("#")]),t._v(" 用户日志")]),t._v(" "),a("p",[t._v("可以通过添加装饰器、对类方法进行劫持等方式来进行日志的自动打印")]),t._v(" "),a("h2",{attrs:{id:"参考资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[t._v("#")]),t._v(" 参考资料")]),t._v(" "),a("ul",[a("li",[t._v("王贝珊（被删）"),a("a",{attrs:{href:"https://kaiwu.lagou.com/course/courseInfo.htm?courseId=822#/detail/pc?id=7215",target:"_blank",rel:"noopener noreferrer"}},[t._v("如何搭建前端监控体系为业务排忧解难？"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.bilibili.com/video/BV1K64y1y7pS?is_hidden_weiban_logo=0",target:"_blank",rel:"noopener noreferrer"}},[t._v("前端监控体系中，性能监控的实现及优化实践-林溪"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/79996898",target:"_blank",rel:"noopener noreferrer"}},[t._v("如何优雅的监控前端页面性能"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.zhihu.com/market/paid_column/1167078439772721152/section/1169977684410564608",target:"_blank",rel:"noopener noreferrer"}},[t._v("前端开发核心知识进阶：50 讲从夯实基础到突破瓶颈"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=e.exports}}]);